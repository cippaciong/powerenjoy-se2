\pagebreak
\section{Architectural Design}
 
\subsection{High level components}
Based on the requirements described in the RASD, we designed an architecture which is based
on two main principles: Client-Server and Microservices paradigms.

\subsubsection{Client-Server}
The client-server aspect of our application can be seen in Figure~\ref{fig:h_l_comp}.
There we focus on the "physical" representation of our application. By saying physical we mean that
every component depicted there will probably reside on separate machines (or is an external service).
To be precise we should have added another component between clients and
application server which is the reverse proxy/web server. The reason why we preferred to
omit it is that, at this stage, we want to address only the aspects that are relevant to the
application development and that layer can be considered transparent with respect to the application.
The application does not have to deal with it explicitly.
Of course this will not be the same in a context of deployment.

\subsubsection{Microservices}
Figure~\ref{fig:i_h_l_comp} is a high level overview of the application internals stripped from all
the external components. We are going to describe its architecture further in this document
but we wanted nonetheless to give an initial idea.
The internal structure of the application is going to be a service oriented architecture.
We will try to build microservices that will deal with single, atomic, responsibilities.

\begin{sidewaysfigure}
\centering
\includegraphics[width=\textwidth]{high_level_components}
\caption{Component view: High Level Architecture}
\label{fig:h_l_comp}
\end{sidewaysfigure}

\begin{sidewaysfigure}
\centering
\includegraphics[width=\textwidth]{internal_high_level_components}
\caption{Component view: Internal High Level Architecture}
\label{fig:i_h_l_comp}
\end{sidewaysfigure}

\pagebreak
\subsection{Low level components}
In this section we are going to describe further the internal configuration of our server
application. After giving a general overview, we will analyze each component separately.
As we anticipated in the previous section, the application is going to follow the microservices
architecture internally with some functions delegated to external services or components.
We will start by describing the latter and then we will move on to the internal ones.
To do so we will use Figure~\ref{fig:i_l_l_comp} as a reference.
In that diagram you can see a more detailed example of what we have already seen
in Figure~\ref{fig:i_h_l_comp}.

\subsubsection{Map API}
Starting from the latter, we assume that all functions related to the map (path finding,
distance calculation, map representation, etc) will be delegated to the Google Maps API.
All the classes that are going to use that API will provide an additional interface if they 
need to expose some functionalities to the other components.
\subsubsection{POS API}
The other aspect that we are not going to develop internally is the Payment Service (POS).
In this case we are going to use the simple an powerful Stripe service that have been chosen
for its ease of use and of integration.
\subsubsection{Database}
Finally, the last component that will not be part of the application in a strict way is the database.
It won't be an entirely external service since we are going to host and mange it in our infrastructure,
but it's still something our application will user through its dedicated API. Regarding the
database we will use the solid and well tested PostgreSQL relational database.

\begin{sidewaysfigure}
\centering
\includegraphics[width=\textwidth]{low_level_components}
\caption{Component view: Internal Low Level Architecture}
\label{fig:i_l_l_comp}
\end{sidewaysfigure}

\pagebreak
\subsubsection{Router}
The Router is the first of our internal component. The idea behind is that this is the component
delegated to do the initial parsing of the request coming from the client. It will analyze
the URI and the HTTP method following the REST principles and based on that informations,
it will produce a message to be enqueued. Once it will get back a reply from the service
corresponding to the initial request, it will send back that response to the client.

\subsubsection{UserHandler}
This service deals with everything that concerns users. It's invoked to perform user creation
and to deal with requests coming from users devices. All the informations involving users
will be passed from the router to this component. In order to gather the required information
it may invokes other services as well.

\subsubsection{CarHandler}
This is the car counterpart of what we have already discussed for users. This component will
register new cars when they are added to the system and provide informations about cars
position, charge status or availability.

\subsubsection{ReservationHandler}
ReservationHandler provides informations related to reservations. It is likely that it will
respond to UserHandler messages when the list of reservations for a single user is requested.
Alternatively, CarHandler can retrieve a list of all reserved cars. 

\subsubsection{RideHandler}
This is the component that handles all rides information. It can be queried in order to have
a list of all rides, of the active ones, rides belonging to a specific user
(they may be active or not) and is the link to payment and discount informations. All the informations
displayed on the car monitor during the ride are gathered from this service.

\subsubsection{PaymentHandler}
The PaymentHandler has to main purposes. The first one is to manage the operations dealing
with the external Payment service. The second one is to save information about users payments
after it gets a reply from the external service. 
This is done in order to provide a history of all payments or a list of pending payments.


\subsubsection{AreaHandler}
This component is in charge of operations dealing with all the safe areas belonging to the company.
Safe areas are stored to know exactly their position and the type of the safe area, being it
a normal area or a power grid station.

\subsection{Deployment}
\begin{sidewaysfigure}
\centering
\includegraphics[width=\textwidth]{deployment}
\caption{Component view: Internal Low Level Architecture}
\label{fig:depl}
\end{sidewaysfigure}
